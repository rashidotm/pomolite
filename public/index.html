<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="PomoLite — a lightweight pomodoro timer with Focus, Short Break, and Long Break stages. Configurable durations and colors, audio alerts, no dependencies.">
  <title>PomoLite</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --accent: #e74c3c;
      --accent-dim: rgba(231, 76, 60, 0.15);
      --bg: #1a1a2e;
      --surface: #16213e;
      --text: #eee;
      --text-dim: #999;
    }

    body.focus  { --accent: #e74c3c; --accent-dim: rgba(231, 76, 60, 0.15); }
    body.short  { --accent: #3498db; --accent-dim: rgba(52, 152, 219, 0.15); }
    body.long   { --accent: #2ecc71; --accent-dim: rgba(46, 204, 113, 0.15); }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      min-height: 100dvh;
      transition: background 0.3s;
      padding: 1rem 1rem 2.5rem;
    }

    .stages {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .stage-btn {
      background: var(--surface);
      color: var(--text-dim);
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 0.5rem 0.8rem;
      cursor: pointer;
      font-size: 0.85rem;
      font-family: inherit;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      transition: border-color 0.3s, color 0.3s, background 0.3s;
    }

    .stage-btn:hover {
      background: var(--accent-dim);
    }

    .stage-btn.active {
      border-color: var(--accent);
      color: var(--text);
    }

    .stage-btn .label { pointer-events: none; }

    .stage-btn .color-row {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .stage-btn input[type="color"] {
      -webkit-appearance: none;
      appearance: none;
      width: 1.6rem;
      height: 1.6rem;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      padding: 0;
      cursor: pointer;
      background: none;
    }

    .stage-btn input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
    .stage-btn input[type="color"]::-webkit-color-swatch { border: none; border-radius: 2px; }
    .stage-btn input[type="color"]::-moz-color-swatch { border: none; border-radius: 2px; }

    .stage-btn input[type="number"] {
      width: 4.5rem;
      text-align: center;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
      padding: 0.35rem 0.3rem;
    }

    .stage-btn input:focus {
      outline: 1px solid var(--accent);
      border-color: var(--accent);
    }

    .timer-display {
      font-size: 6rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: rgba(255, 255, 255, 0.12);
      letter-spacing: 0.04em;
      line-height: 1;
      transition: color 0.3s;
    }

    .controls {
      display: flex;
      gap: 0.75rem;
    }

    .controls button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.7rem 1.8rem;
      font-size: 1rem;
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s, opacity 0.2s;
      min-width: 7rem;
    }

    .controls button:hover { opacity: 0.85; }

    #resetBtn {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
      transition: border-color 0.3s, color 0.3s;
    }

    #resetBtn:hover { opacity: 0.85; }

    #clearSettingsBtn {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
      min-width: auto;
      padding: 0.7rem;
      font-size: 1.1rem;
      line-height: 1;
      transition: border-color 0.3s, color 0.3s;
    }

    .cards {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .card {
      background: var(--surface);
      border-radius: 16px;
      padding: 1.5rem 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .cycle-bar {
      margin-top: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 0.3rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .cycle-bar .step { opacity: 0.4; }
    .cycle-bar .step.active { opacity: 1; color: var(--accent); text-decoration: underline; }
    .cycle-bar .arrow { opacity: 0.3; }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--surface);
      font-size: 0.75rem;
      color: var(--text-dim);
      text-align: center;
      padding: 0.5rem;
    }

    .footer a {
      color: var(--text-dim);
      text-decoration: underline;
    }

    @media (max-width: 480px) {
      .timer-display { font-size: 3.8rem; }
      h1 { font-size: 1.3rem; margin-bottom: 1.5rem; }
      .controls button { padding: 0.6rem 1.2rem; font-size: 0.9rem; min-width: 5.5rem; }
      .stage-btn { padding: 0.4rem 0.6rem; font-size: 0.78rem; }
      .card { padding: 1rem 1rem; border-radius: 12px; }
      .cards { gap: 0.75rem; }
    }
  </style>
</head>
<body class="focus">

  <div class="cards">
    <div class="card">
      <div class="stages">
        <button class="stage-btn active" data-stage="focus" tabindex="-1">
          <span class="label">Focus</span>
          <input type="number" min="1" max="120" value="25" data-stage-input="focus" aria-label="Focus minutes">
    
          <div class="color-row">
    
            <input type="color" value="#e74c3c" data-stage-color="focus" aria-label="Focus background color" tabindex="-1">
          </div>
        </button>
        <button class="stage-btn" data-stage="short" tabindex="-1">
          <span class="label">Short Break</span>
          <input type="number" min="1" max="60" value="5" data-stage-input="short" aria-label="Short break minutes">
    
          <div class="color-row">
    
            <input type="color" value="#3498db" data-stage-color="short" aria-label="Short break background color" tabindex="-1">
          </div>
        </button>
        <button class="stage-btn" data-stage="long" tabindex="-1">
          <span class="label">Long Break</span>
          <input type="number" min="1" max="60" value="15" data-stage-input="long" aria-label="Long break background color">
    
          <div class="color-row">
    
            <input type="color" value="#2ecc71" data-stage-color="long" aria-label="Long break background color" tabindex="-1">
          </div>
        </button>
      </div>
    </div>

    <div class="card">
      <div class="timer-display" id="timerDisplay">25:00</div>
      <div class="cycle-bar" id="cycleBar"></div>
    </div>

    <div class="card">
      <div class="controls">
        <button id="startBtn" tabindex="-1">Start</button>
        <button id="resetBtn" tabindex="-1">Reset</button>
        <button id="clearSettingsBtn" title="Reset settings" tabindex="-1">&#x1F5D1;</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <a href="https://github.com/rashidotm/pomolite" target="_blank">GitHub</a> · v1.3.0
  </footer>

  <script>
    (function () {
      // Cached DOM refs
      var display = document.getElementById('timerDisplay');
      var startBtn = document.getElementById('startBtn');
      var resetBtn = document.getElementById('resetBtn');
      var cycleBarEl = document.getElementById('cycleBar');
      var body = document.body;
      var stageBtns = document.querySelectorAll('.stage-btn');
      var stageInputs = {
        focus: document.querySelector('[data-stage-input="focus"]'),
        short: document.querySelector('[data-stage-input="short"]'),
        long:  document.querySelector('[data-stage-input="long"]')
      };
      var colorInputs = {
        focus: document.querySelector('[data-stage-color="focus"]'),
        short: document.querySelector('[data-stage-color="short"]'),
        long:  document.querySelector('[data-stage-color="long"]')
      };

      // Persist settings
      function saveSettings() {
        localStorage.setItem('pomolite', JSON.stringify({ durations: durations, bgColors: bgColors }));
      }
      function loadSettings() {
        try { return JSON.parse(localStorage.getItem('pomolite')); } catch (e) { return null; }
      }

      // State
      var saved = loadSettings();
      var currentStage = 'focus';
      var durations = saved && saved.durations || { focus: 1500, short: 300, long: 900 };
      var bgColors = saved && saved.bgColors || { focus: '#e74c3c', short: '#3498db', long: '#2ecc71' };
      var secondsLeft = durations.focus;
      var running = false;
      var intervalId = null;
      var endTime = 0;
      var audioCtx = null;
      var cycle = ['F','SB','F','SB','F','SB','F','SB','F','LB'];
      var cycleIndex = 0;

      // Format seconds as MM:SS
      function formatTime(s) {
        var m = Math.floor(s / 60);
        var sec = s % 60;
        return (m < 10 ? '0' + m : m) + ':' + (sec < 10 ? '0' + sec : sec);
      }

      function updateDisplay() {
        display.textContent = formatTime(secondsLeft);
        document.title = formatTime(secondsLeft) + ' - PomoLite';
      }

      function renderCycle() {
        var html = '';
        for (var i = 0; i < cycle.length; i++) {
          if (i > 0) html += '<span class="arrow">→</span>';
          html += '<span class="step' + (i === cycleIndex ? ' active' : '') + '">' + cycle[i] + '</span>';
        }
        cycleBarEl.innerHTML = html;
      }

      function setStageUI() {
        body.className = currentStage;
        body.style.background = bgColors[currentStage];
        for (var i = 0; i < stageBtns.length; i++) {
          stageBtns[i].classList.toggle('active', stageBtns[i].getAttribute('data-stage') === currentStage);
        }
      }

      function switchStage(stage) {
        if (stage === currentStage && !running) return;
        stopTimer();
        currentStage = stage;
        secondsLeft = durations[stage];
        startBtn.textContent = 'Start';
        setStageUI();
        updateDisplay();
      }

      function stopTimer() {
        if (intervalId !== null) {
          clearInterval(intervalId);
          intervalId = null;
        }
        running = false;
      }

      function tick() {
        var now = Date.now();
        secondsLeft = Math.max(0, Math.round((endTime - now) / 1000));
        updateDisplay();
        if (secondsLeft <= 0) {
          stopTimer();
          onTimerComplete();
        }
      }

      function startTimer() {
        if (secondsLeft <= 0) return;
        running = true;
        endTime = Date.now() + secondsLeft * 1000;
        startBtn.textContent = 'Pause';
        intervalId = setInterval(tick, 250);
      }

      function onTimerComplete() {
        playAlert();

        // Advance cycle
        cycleIndex = (cycleIndex + 1) % cycle.length;
        var label = cycle[cycleIndex];
        var nextStage = label === 'F' ? 'focus' : label === 'SB' ? 'short' : 'long';

        // Auto-advance
        currentStage = nextStage;
        secondsLeft = durations[nextStage];
        setStageUI();
        updateDisplay();
        renderCycle();

        // Auto-start after a brief delay so user sees the stage change
        setTimeout(function () { startTimer(); }, 1200);
      }

      // Sound via Web Audio API
      function unlockAudio() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }
        // iOS needs a silent buffer played from a user gesture to fully unlock
        var buf = audioCtx.createBuffer(1, 1, 22050);
        var src = audioCtx.createBufferSource();
        src.buffer = buf;
        src.connect(audioCtx.destination);
        src.start(0);
      }

      function getAudioCtx() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        return audioCtx;
      }

      function beep(ctx, startAt) {
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 660;
        gain.gain.setValueAtTime(0.3, startAt);
        gain.gain.exponentialRampToValueAtTime(0.001, startAt + 0.3);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(startAt);
        osc.stop(startAt + 0.3);
      }

      function playAlert() {
        var ctx = getAudioCtx();
        var now = ctx.currentTime;
        beep(ctx, now);
        beep(ctx, now + 0.5);
        beep(ctx, now + 1.0);
      }

      // Event listeners — stage buttons
      for (var i = 0; i < stageBtns.length; i++) {
        (function (btn) {
          btn.addEventListener('click', function (e) {
            // Don't switch stage when clicking the input
            if (e.target.tagName === 'INPUT') return;
            unlockAudio();
            switchStage(btn.getAttribute('data-stage'));
          });
        })(stageBtns[i]);
      }

      // Event listeners — duration inputs
      function bindInput(stage) {
        var input = stageInputs[stage];
        input.addEventListener('click', function (e) { e.stopPropagation(); input.select(); });
        input.addEventListener('change', function () {
          var val = parseInt(input.value, 10);
          if (isNaN(val) || val < 1) val = 1;
          if (val > 120) val = 120;
          input.value = val;
          durations[stage] = val * 60;
          saveSettings();
          if (stage === currentStage && !running) {
            secondsLeft = durations[stage];
            updateDisplay();
          }
        });
      }
      bindInput('focus');
      bindInput('short');
      bindInput('long');

      // Event listeners — color pickers
      function bindColor(stage) {
        var input = colorInputs[stage];
        input.addEventListener('click', function (e) { e.stopPropagation(); });
        input.addEventListener('input', function () {
          bgColors[stage] = input.value;
          saveSettings();
          if (stage === currentStage) {
            body.style.background = input.value;
          }
        });
      }
      bindColor('focus');
      bindColor('short');
      bindColor('long');

      // Start / Pause
      startBtn.addEventListener('click', function () {
        unlockAudio();
        if (running) {
          stopTimer();
          startBtn.textContent = 'Resume';
        } else {
          startTimer();
        }
      });

      // Clear settings — restore defaults
      var defaults = { durations: { focus: 1500, short: 300, long: 900 }, bgColors: { focus: '#e74c3c', short: '#3498db', long: '#2ecc71' } };
      document.getElementById('clearSettingsBtn').addEventListener('click', function () {
        localStorage.removeItem('pomolite');
        durations = { focus: defaults.durations.focus, short: defaults.durations.short, long: defaults.durations.long };
        bgColors = { focus: defaults.bgColors.focus, short: defaults.bgColors.short, long: defaults.bgColors.long };
        ['focus', 'short', 'long'].forEach(function (s) {
          stageInputs[s].value = durations[s] / 60;
          colorInputs[s].value = bgColors[s];
        });
        if (!running) {
          secondsLeft = durations[currentStage];
          updateDisplay();
        }
        setStageUI();
      });

      // Reset — clear all runtime state, keep user-configured durations & colors
      resetBtn.addEventListener('click', function () {
        stopTimer();
        cycleIndex = 0;
        currentStage = 'focus';
        secondsLeft = durations.focus;
        startBtn.textContent = 'Start';
        setStageUI();
        updateDisplay();
        renderCycle();
      });

      // Init — restore saved settings to inputs
      if (saved) {
        ['focus', 'short', 'long'].forEach(function (s) {
          stageInputs[s].value = durations[s] / 60;
          colorInputs[s].value = bgColors[s];
        });
        secondsLeft = durations.focus;
      }
      setStageUI();
      updateDisplay();
      renderCycle();
    })();
  </script>
</body>
</html>
